# DDKBot-Recipe

The DDBBot is DDK's chat bot, currently used in the [Contact Me](https://www.ddklimited.com/contact/) page on our web site and is based on Microsoft's Bot Framework, Azure Infrastructure and Azure cognitive Services, LUIS and QnA Maker.

We make use of the Bot Framework v4 NLP with Dispatch bot sample.

This bot has been created using [Bot Framework](https://dev.botframework.com), it shows how to create a bot that relies on multiple [LUIS.ai](https://www.luis.ai) and [QnAMaker.ai](https://www.qnamaker.ai) models for natural language processing (NLP).

The structure of the Git repository is as follows:

## Code/Application: Application Code
Path | File | Description
--- | --- | ---
.github/workflows | Main.yml | This is a Github workflow file that automates deployment.<br>It checks out the code from git, build and runs the .net app from the code and deploys to the Azure Web App (created with the infrastructure scripts).
Code/Application/ | | This folder contains all the code and configuration files for the DDK Bot.
Code/Application/ | AdapterWithErrorHandler.cs | Error Handler for the bot. 
Code/Application/ | appsettings.json | Application config settings referenced in the code. We don't  make use of the settings here as we use environmental variables on the relevant Azure service or the Azure Key Vault for more sensitive information. In the VSCode, environment variables can be simulated in the .vscode/launch.json file.
Code/Application/ | BotDispatch-knowledge-1.dispatch | Dispatch configuration file generated by the dispatch command line tool and used in the generation of the Dispatch LUIS model, BotDispatch-knowledge-1 and supporting config files that reside in the data folder. Serious faff involved in getting the correct app id and key for the endpoints!
Code/Application/ | BotServices.cs | Sets up the services used by the bot; QnA Maker, LUIS and the Key Vault(to get access to the secrets for connectivity).
Code/Application/ | ConversationData.cs | Used to maintain the state of data during a conversation.
Code/Application/ | DDKBot.csproj | C# Project file
Code/Application/ | getmysecret.cs | Returns the specified secret from the Azure Key Vault
Code/Application/ | IBotServices.cs | A Bot Services Interface. The BotServices class implements this interface and provides an implementation of its members.
Code/Application/ | Program.cs | ASP.NET Core web application is actually a console project which starts executing from the entry point public static void Main() in Program class where we can create a host for the web application. **dotnet new webapp** creates this file.
Code/Application/ | Startup.cs | ASP.NET Core application must include a Startup class. It is like Global.asax in the traditional .NET application. As the name suggests, it is executed first when the application starts. This startup file use the Dependency Injection pattern to avoid direct dependencies and dependency chains to the Bot Service, Framework and other classes. **dotnet new webapp** creates this file.
Code/Application/ | UserProfile.cs | Defines a state property used to track information about the user as part of the User Dialog
Code/Application/ | web.config  |The web.config is a file that is read by IIS and the ASP.NET Core Module to configure an app hosted with IIS. A a bit of a legacy file.
/Bots | DispatchBot.cs | The file controls the flow of the conversation, accesses state to help remember where it is in the conversation and what has already been said   and dispatches the request to the best matched intent, served by either LUIS or the QNA Maker. The bots makes use of Turns and context, so have a look at [How Bots Work][1] for more insight into this.
/Controller | BotController.cs | A MVC controller file used routing POST requests to the relevant REST service. 
/data | | This folder contains the data to allow the bot to match the users utterance with a best matched intent to then subsequently route to the appropriate intent in LUIS and/or QnA maker or deal with it internally. The data is generated by using the [Dispatch Command Line tool][3]
/Dialogs | UserProfileDialog.cs | A waterfall sequence of steps the bot runs through with the user. In our case we use the waterfall dialog to capture the users contact details.
/wwwroot | default.htm | The default web page that is served when you run the DDK Bot application. Its merely an information page that lets you know how to connect to the DDK Bot REST service wne running in development and test setup.
/properties | LaunchSettings.json | How your project should be started in development scenarios. **dotnet new webapp** creates this file.


## Code/Infrastructure: Infrastructure Code

Infrastructure | File | Description
--- | --- | ---
Azure Bot Channel Registration | |
Azure App Service Plan | |
Azure App Service | |
Azure Key Vault | |
Azure Container Registry | |
Azure Resource Groups | |


##  Language and QnA Maker cognitive services
There are 4 LUIS and 1 QnAmaker models that have been trained and published.  

Model | Azure Resource | Description
--- | ---
 botdispatch-knowledge-1 | DDK-luis-Greeting-Authoring | The dispatch tool needs authoring access to read the existing LUIS and QnA Maker apps in order to create a new parent LUIS Model ( botdispatch-knowledge-1) that dispatches to the appropriate LUIS and QnA Maker Conversation apps!
 DDK-luis-thanks | DDK-luis-Greeting | 2 * Intents, Thanks (with example utterances) and None, 0 entities and 1 features. 
 DDK-luis-bye | DDK-luis-Greeting | 2 * Intents, Bye (with example utterances) and None, 0 entities,  2 features.
 DDK-luis-contact | DDK-luis-Greeting | 2 * Intents, Contact Me (with example utterances) and None,  0 entities, 3 features.
 DDK-luis-greeting | DDK-luis-Greeting | 2 * Intents, Hello (with example utterances) and None,  0 entities, 2 features.




The QnA maker deals with question people have about the organisation and what we do and sell.  
The 4 LUIs model deals with greetings and contacts.
There is 1 LUIS Model, created by the dispatcher, that is used to understand abd route requests to the appropriate LUIS Model.



# VsCode Extensions
* NuGet Package Manager
* C#
* Code Spell Checker
* GitHub

# Package Dependencies
<PackageReference Include="Azure.Identity" Version="1.2.3" />
    <PackageReference Include="Azure.Security.KeyVault.Keys" Version="4.1.0" />
    <PackageReference Include="Azure.Security.KeyVault.Secrets" Version="4.1.0" />
    <PackageReference Include="Microsoft.AspNetCore.Mvc.NewtonsoftJson" Version="3.1.1" />
    <PackageReference Include="Microsoft.Azure.KeyVault.Core" Version="3.0.5" />
    <PackageReference Include="Microsoft.Bot.Builder" Version="4.10.3" />
    <PackageReference Include="Microsoft.Bot.Builder.AI.Luis" Version="4.10.3" />
    <PackageReference Include="Microsoft.Bot.Builder.AI.QnA" Version="4.10.3" />
    <PackageReference Include="Microsoft.Bot.Builder.Azure" Version="4.10.3" />
    <PackageReference Include="Microsoft.Bot.Builder.Azure.Blobs" Version="4.10.3" />
    <PackageReference Include="Microsoft.Bot.Builder.Integration.AspNet.Core" Version="4.10.3" />
    <PackageReference Include="Microsoft.Extensions.Configuration.AzureKeyVault" Version="3.1.9" />

## Useful References

[How Bots Work][1]  
[use multiple LUIS and QnA Models][2]  
[Dispatch Command Line tool][3]  
[Waterfall Dialogs][4]

[1]: [https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0#:~:text=As%20mentioned%20above%2C%20the%20turn,runs%20in%20an%20asynchronous%20process.] 
[2]: [https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-tutorial-dispatch?view=azure-bot-service-4.0&tabs=cs]
[3]: https://github.com/Microsoft/botbuilder-tools/tree/master/packages/Dispatch
[4]: https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-waterfall-dialogs?view=azure-bot-service-4.0

## Further reading

- [Bot Framework Documentation](https://docs.botframework.com)
- [Bot Basics](https://docs.microsoft.com/azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0)
- [Using LUIS for Language Understanding](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-v4-luis?view=azure-bot-service-4.0&tabs=js)
- [LUIS documentation](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/)
- [Activity processing](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-activity-processing?view=azure-bot-service-4.0)
- [Azure Bot Service Introduction](https://docs.microsoft.com/azure/bot-service/bot-service-overview-introduction?view=azure-bot-service-4.0)
- [Azure Bot Service Documentation](https://docs.microsoft.com/azure/bot-service/?view=azure-bot-service-4.0)
- [.NET Core CLI tools](https://docs.microsoft.com/en-us/dotnet/core/tools/?tabs=netcore2x)
- [Azure CLI](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest)
- [Azure Portal](https://portal.azure.com)
- [Language Understanding using LUIS](https://docs.microsoft.com/en-us/azure/cognitive-services/luis/)
- [Channels and Bot Connector Service](https://docs.microsoft.com/en-us/azure/bot-service/bot-concepts?view=azure-bot-service-4.0)
- [Intents classify utterances](https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-model#intents-classify-utterances)
